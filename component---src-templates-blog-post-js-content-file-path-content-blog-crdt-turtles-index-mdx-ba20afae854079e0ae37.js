"use strict";(self.webpackChunkasync_stream_blog=self.webpackChunkasync_stream_blog||[]).push([[360],{6163:function(e,t,a){a.d(t,{A:function(){return m}});var l=a(6540),s=a(4848);function n({id:e,host:t,repo:n,repoId:m,category:c,categoryId:r,mapping:i,term:p,strict:o,reactionsEnabled:E,emitMetadata:h,inputPosition:u,theme:g,lang:d,loading:N}){const[y,v]=(0,l.useState)(!1);return(0,l.useEffect)((()=>{y||a.e(416).then(a.bind(a,416)).then((()=>v(!0)))}),[]),y?(0,s.jsx)("giscus-widget",{id:e,host:t,repo:n,repoid:m,category:c,categoryid:r,mapping:i,term:p,strict:o,reactionsenabled:E,emitmetadata:h,inputposition:u,theme:g,lang:d,loading:N}):null}var m=()=>l.createElement("div",{className:"comments-wrapper"},l.createElement(n,{repo:"jhellerstein/blog",repoId:"R_kgDOOlLShQ",category:"Comments",categoryId:"DIC_kwDOOlLShc4CqUp7",mapping:"pathname",term:"Welcome to the async stream blog.",strict:"0",reactionsEnabled:"1",emitMetadata:"0",inputPosition:"bottom",theme:"light",lang:"en",loading:"lazy",crossOrigin:"anonymous",async:!0}))},9087:function(e,t,a){a.r(t),a.d(t,{Head:function(){return u},default:function(){return g}});var l=a(8453),s=a(6540);function n(e){const t=Object.assign({p:"p",a:"a",em:"em",ul:"ul",li:"li",h2:"h2",strong:"strong",span:"span",blockquote:"blockquote",math:"math",semantics:"semantics",mrow:"mrow",mi:"mi",annotation:"annotation",mo:"mo",mtext:"mtext",h3:"h3",div:"div",msub:"msub",mn:"mn",h4:"h4",mtable:"mtable",mtr:"mtr",mtd:"mtd",mstyle:"mstyle",svg:"svg",path:"path",ol:"ol"},(0,l.RP)(),e.components);return s.createElement(s.Fragment,null,s.createElement("blockquote",{class:"quote"},s.createElement("p",null,s.createElement(t.p,null,"After a lecture on cosmology, William James was challenged by a skeptic:")),s.createElement("p",null,s.createElement(t.p,null,'"Your theories are incorrect. The Earth rests on a turtle,"',s.createElement("br"),'\n"And what holds up the turtle?" James asked.  ',s.createElement("br"),'\n"Another turtle," came the reply. ',s.createElement("br"),'\n"And what holds that up?" pressed James.')),s.createElement("p",null,s.createElement(t.p,null,"The skeptic was undeterred:",s.createElement("br"),"\n\"You can't fool me, sir. It's turtles all the way down.\"")),s.createElement("p",null,s.createElement("em",null,"‚Äî Anecdote attributed to William James (",s.createElement(t.a,{href:"https://en.wikipedia.org/wiki/Turtles_all_the_way_down"},"via J.R. Ross, 1967"),")"))),"\n",s.createElement(t.p,null,s.createElement(t.em,null,"This is the 2nd post in a series of 4 posts I'm doing on CRDTs. Please see the ",s.createElement(t.a,{href:"../crdt-intro/"},"intro post")," for context.")),"\n",s.createElement(t.p,null,"Modern distributed systems often seem to rest on an stack of turtles.\nFor every guarantee we make, we seem to rely on a lower-layer assumption. Eventually we're left wondering: what ",s.createElement(t.em,null,"is")," at the bottom?"),"\n",s.createElement(t.p,null,"CRDTs ‚Äî ",s.createElement(t.em,null,"Conflict-Free Replicated Data Types")," ‚Äî are often advertised as a foundation we can finally trust.\nThey promise convergence of state across machines ",s.createElement(t.em,null,"without")," requiring perfect clocks, global operation ordering, or causal message delivery ... and they do it with math."),"\n",s.createElement(t.p,null,"But many CRDTs sneak in assumptions that don't belong. That's not solid ground. It's not math. It's turtles."),"\n",s.createElement(t.p,null,"In this post, we‚Äôll show how to design CRDT internals properly:"),"\n",s.createElement(t.ul,null,"\n",s.createElement(t.li,null,"\n",s.createElement(t.p,null,"‚úÖ Always in terms of a semilattice structure."),"\n"),"\n",s.createElement(t.li,null,"\n",s.createElement(t.p,null,"‚úÖ Always with clean algebraic reasoning, without hidden dependencies."),"\n"),"\n",s.createElement(t.li,null,"\n",s.createElement(t.p,null,"‚úÖ With explicit causality lattices included whenever needed."),"\n"),"\n"),"\n",s.createElement(t.p,null,"This will ensure we're always using careful reasoning."),"\n",s.createElement(t.p,null,s.createElement(t.em,null,"Correct CRDTs are semilattices at bottom.")," And that's math you can count on."),"\n",s.createElement(t.h2,null,"üê¢ A Principle for CRDTs: Semilattices All the Way Down"),"\n",s.createElement(t.p,null,"Every well-designed CRDT is a ",s.createElement(t.strong,null,"semilattice"),"."),"\n",s.createElement(t.ul,null,"\n",s.createElement(t.li,null,"‚úÖ A semilattice defines how information grows and ",s.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">merge</code>'}}),"s."),"\n",s.createElement(t.li,null,"‚úÖ It provides convergence by construction, through clean algebra."),"\n"),"\n",s.createElement(t.p,null,'In case you\'ve read about a split between so-called "state-based" vs "op-based" CRDTs, you can ignore that for now; it\'s a turtlish distraction I will ',s.createElement(t.a,{href:"#op-based"},"fill in below"),". Here‚Äôs what actually matters:"),"\n",s.createElement(t.blockquote,null,"\n",s.createElement(t.p,null,"A semilattice is:"),"\n",s.createElement(t.ul,null,"\n",s.createElement(t.li,null,"A set of states ",s.createElement(t.span,{className:"math math-inline"},s.createElement(t.span,{className:"katex"},s.createElement(t.span,{className:"katex-mathml"},s.createElement(t.math,{xmlns:"http://www.w3.org/1998/Math/MathML"},s.createElement(t.semantics,null,s.createElement(t.mrow,null,s.createElement(t.mi,null,"S")),s.createElement(t.annotation,{encoding:"application/x-tex"},"S")))),s.createElement(t.span,{className:"katex-html","aria-hidden":"true"},s.createElement(t.span,{className:"base"},s.createElement(t.span,{className:"strut",style:{height:"0.6833em"}}),s.createElement(t.span,{className:"mord mathnormal",style:{marginRight:"0.05764em"}},"S")))))),"\n",s.createElement(t.li,null,"A ",s.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">join</code>'}})," function ",s.createElement(t.span,{className:"math math-inline"},s.createElement(t.span,{className:"katex"},s.createElement(t.span,{className:"katex-mathml"},s.createElement(t.math,{xmlns:"http://www.w3.org/1998/Math/MathML"},s.createElement(t.semantics,null,s.createElement(t.mrow,null,s.createElement(t.mo,null,"‚äî"),s.createElement(t.mo,null,":"),s.createElement(t.mi,null,"S"),s.createElement(t.mo,null,"√ó"),s.createElement(t.mi,null,"S"),s.createElement(t.mo,null,"‚Üí"),s.createElement(t.mi,null,"S")),s.createElement(t.annotation,{encoding:"application/x-tex"},"\\sqcup : S \\times S \\to S")))),s.createElement(t.span,{className:"katex-html","aria-hidden":"true"},s.createElement(t.span,{className:"base"},s.createElement(t.span,{className:"strut",style:{height:"0.5556em"}}),s.createElement(t.span,{className:"mord"},"‚äî"),s.createElement(t.span,{className:"mspace",style:{marginRight:"0.2778em"}}),s.createElement(t.span,{className:"mrel"},":"),s.createElement(t.span,{className:"mspace",style:{marginRight:"0.2778em"}})),s.createElement(t.span,{className:"base"},s.createElement(t.span,{className:"strut",style:{height:"0.7667em",verticalAlign:"-0.0833em"}}),s.createElement(t.span,{className:"mord mathnormal",style:{marginRight:"0.05764em"}},"S"),s.createElement(t.span,{className:"mspace",style:{marginRight:"0.2222em"}}),s.createElement(t.span,{className:"mbin"},"√ó"),s.createElement(t.span,{className:"mspace",style:{marginRight:"0.2222em"}})),s.createElement(t.span,{className:"base"},s.createElement(t.span,{className:"strut",style:{height:"0.6833em"}}),s.createElement(t.span,{className:"mord mathnormal",style:{marginRight:"0.05764em"}},"S"),s.createElement(t.span,{className:"mspace",style:{marginRight:"0.2778em"}}),s.createElement(t.span,{className:"mrel"},"‚Üí"),s.createElement(t.span,{className:"mspace",style:{marginRight:"0.2778em"}})),s.createElement(t.span,{className:"base"},s.createElement(t.span,{className:"strut",style:{height:"0.6833em"}}),s.createElement(t.span,{className:"mord mathnormal",style:{marginRight:"0.05764em"}},"S")))))," that must satisfy ",s.createElement(t.strong,null,"commutativity"),", ",s.createElement(t.strong,null,"associativity"),", and ",s.createElement(t.strong,null,"idempotence"),".\nThe ",s.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">join</code>'}})," function induces a partial order:\n",s.createElement(t.span,{className:"math math-inline"},s.createElement(t.span,{className:"katex"},s.createElement(t.span,{className:"katex-mathml"},s.createElement(t.math,{xmlns:"http://www.w3.org/1998/Math/MathML"},s.createElement(t.semantics,null,s.createElement(t.mrow,null,s.createElement(t.mi,null,"x"),s.createElement(t.mo,null,"‚â§"),s.createElement(t.mi,null,"y"),s.createElement(t.mtext,null,"‚ÄÖ‚Ää"),s.createElement(t.mo,null,"‚ü∫"),s.createElement(t.mtext,null,"‚ÄÖ‚Ää"),s.createElement(t.mi,null,"x"),s.createElement(t.mo,null,"‚äî"),s.createElement(t.mi,null,"y"),s.createElement(t.mo,null,"="),s.createElement(t.mi,null,"y")),s.createElement(t.annotation,{encoding:"application/x-tex"},"x \\leq y \\iff x \\sqcup y = y")))),s.createElement(t.span,{className:"katex-html","aria-hidden":"true"},s.createElement(t.span,{className:"base"},s.createElement(t.span,{className:"strut",style:{height:"0.7719em",verticalAlign:"-0.136em"}}),s.createElement(t.span,{className:"mord mathnormal"},"x"),s.createElement(t.span,{className:"mspace",style:{marginRight:"0.2778em"}}),s.createElement(t.span,{className:"mrel"},"‚â§"),s.createElement(t.span,{className:"mspace",style:{marginRight:"0.2778em"}})),s.createElement(t.span,{className:"base"},s.createElement(t.span,{className:"strut",style:{height:"0.7194em",verticalAlign:"-0.1944em"}}),s.createElement(t.span,{className:"mord mathnormal",style:{marginRight:"0.03588em"}},"y"),s.createElement(t.span,{className:"mspace",style:{marginRight:"0.2778em"}}),s.createElement(t.span,{className:"mspace",style:{marginRight:"0.2778em"}}),s.createElement(t.span,{className:"mrel"},"‚ü∫"),s.createElement(t.span,{className:"mspace",style:{marginRight:"0.2778em"}}),s.createElement(t.span,{className:"mspace",style:{marginRight:"0.2778em"}})),s.createElement(t.span,{className:"base"},s.createElement(t.span,{className:"strut",style:{height:"0.5556em"}}),s.createElement(t.span,{className:"mord mathnormal"},"x"),s.createElement(t.span,{className:"mspace",style:{marginRight:"0.2222em"}}),s.createElement(t.span,{className:"mbin"},"‚äî"),s.createElement(t.span,{className:"mspace",style:{marginRight:"0.2222em"}})),s.createElement(t.span,{className:"base"},s.createElement(t.span,{className:"strut",style:{height:"0.625em",verticalAlign:"-0.1944em"}}),s.createElement(t.span,{className:"mord mathnormal",style:{marginRight:"0.03588em"}},"y"),s.createElement(t.span,{className:"mspace",style:{marginRight:"0.2778em"}}),s.createElement(t.span,{className:"mrel"},"="),s.createElement(t.span,{className:"mspace",style:{marginRight:"0.2778em"}})),s.createElement(t.span,{className:"base"},s.createElement(t.span,{className:"strut",style:{height:"0.625em",verticalAlign:"-0.1944em"}}),s.createElement(t.span,{className:"mord mathnormal",style:{marginRight:"0.03588em"}},"y"))))),"."),"\n"),"\n"),"\n",s.createElement(t.p,null,"When discussing CRDTs, people often use the term ",s.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">merge</code>'}})," instead of ",s.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">join</code>'}}),"."),"\n",s.createElement(t.p,null,'CRDTs sometimes add additional "update" operators:'),"\n",s.createElement(t.blockquote,null,"\n",s.createElement(t.p,null,s.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">update</code>'}}),s.createElement(t.span,{className:"math math-inline"},s.createElement(t.span,{className:"katex"},s.createElement(t.span,{className:"katex-mathml"},s.createElement(t.math,{xmlns:"http://www.w3.org/1998/Math/MathML"},s.createElement(t.semantics,null,s.createElement(t.mrow,null,s.createElement(t.mo,null,":"),s.createElement(t.mi,null,"U"),s.createElement(t.mo,null,"‚Üí"),s.createElement(t.mo,{stretchy:"false"},"("),s.createElement(t.mi,null,"S"),s.createElement(t.mo,null,"‚Üí"),s.createElement(t.mi,null,"S"),s.createElement(t.mo,{stretchy:"false"},")")),s.createElement(t.annotation,{encoding:"application/x-tex"},": U \\to (S \\to S)")))),s.createElement(t.span,{className:"katex-html","aria-hidden":"true"},s.createElement(t.span,{className:"base"},s.createElement(t.span,{className:"strut",style:{height:"0.4306em"}}),s.createElement(t.span,{className:"mrel"},":"),s.createElement(t.span,{className:"mspace",style:{marginRight:"0.2778em"}})),s.createElement(t.span,{className:"base"},s.createElement(t.span,{className:"strut",style:{height:"0.6833em"}}),s.createElement(t.span,{className:"mord mathnormal",style:{marginRight:"0.10903em"}},"U"),s.createElement(t.span,{className:"mspace",style:{marginRight:"0.2778em"}}),s.createElement(t.span,{className:"mrel"},"‚Üí"),s.createElement(t.span,{className:"mspace",style:{marginRight:"0.2778em"}})),s.createElement(t.span,{className:"base"},s.createElement(t.span,{className:"strut",style:{height:"1em",verticalAlign:"-0.25em"}}),s.createElement(t.span,{className:"mopen"},"("),s.createElement(t.span,{className:"mord mathnormal",style:{marginRight:"0.05764em"}},"S"),s.createElement(t.span,{className:"mspace",style:{marginRight:"0.2778em"}}),s.createElement(t.span,{className:"mrel"},"‚Üí"),s.createElement(t.span,{className:"mspace",style:{marginRight:"0.2778em"}})),s.createElement(t.span,{className:"base"},s.createElement(t.span,{className:"strut",style:{height:"1em",verticalAlign:"-0.25em"}}),s.createElement(t.span,{className:"mord mathnormal",style:{marginRight:"0.05764em"}},"S"),s.createElement(t.span,{className:"mclose"},")"))))),"\n",s.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">update</code>'}})," takes an input value of type ",s.createElement(t.span,{className:"math math-inline"},s.createElement(t.span,{className:"katex"},s.createElement(t.span,{className:"katex-mathml"},s.createElement(t.math,{xmlns:"http://www.w3.org/1998/Math/MathML"},s.createElement(t.semantics,null,s.createElement(t.mrow,null,s.createElement(t.mi,null,"U")),s.createElement(t.annotation,{encoding:"application/x-tex"},"U")))),s.createElement(t.span,{className:"katex-html","aria-hidden":"true"},s.createElement(t.span,{className:"base"},s.createElement(t.span,{className:"strut",style:{height:"0.6833em"}}),s.createElement(t.span,{className:"mord mathnormal",style:{marginRight:"0.10903em"}},"U")))))," and uses it to directly mutate the local CRDT's state."),"\n"),"\n",s.createElement(t.p,null,"If all pairs of nodes eventually ",s.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">merge</code>'}})," state in an associative, commutative and idempotent manner, then eventual convergence of a CRDT is guaranteed ‚Äî no further assumptions required."),"\n",s.createElement(t.h2,null,"üîç Common CRDT Mistake: Hiding Assumptions"),"\n",s.createElement(t.p,null,"Many CRDT descriptions assume causal message delivery, message uniqueness, or reliable clocks ... but fail to encode these in their semilattices."),"\n",s.createElement(t.p,null,"üö´ That‚Äôs like putting turtles back under the CRDT again!"),"\n",s.createElement(t.h3,null,"‚úîÔ∏è Design Rule:"),"\n",s.createElement(t.blockquote,null,"\n",s.createElement(t.p,null,"All required assumptions must be ",s.createElement(t.strong,null,"internalized")," in the semilattice structure."),"\n"),"\n",s.createElement(t.ul,null,"\n",s.createElement(t.li,null,"\n",s.createElement(t.p,null,"If your algorithm needs causality, encode it."),"\n"),"\n",s.createElement(t.li,null,"\n",s.createElement(t.p,null,"If it expires or compresses away state, model that algebraically too, and make sure it respects the rules of a semilattice."),"\n"),"\n",s.createElement(t.li,null,"\n",s.createElement(t.p,null,"You can always optimize later (see ",s.createElement(t.a,{href:"#building-on-an-existing-turtle"},"below"),") ... but the math must be sound on its own."),"\n"),"\n"),"\n",s.createElement(t.h2,null,"Case Study: Add/Remove Sets"),"\n",s.createElement(t.p,null,"Let's walk through a concrete example. A 2-Phase (2P) Set is a simple CRDT that tracks a pair of set-based lattices ",s.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">(adds, removes)</code>'}})," where ",s.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">merge</code>'}})," is set-union for each:"),"\n",s.createElement(t.ul,null,"\n",s.createElement(t.li,null,s.createElement(t.strong,null,"adds"),": ",s.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">{(id, element)}</code>'}})),"\n",s.createElement(t.li,null,s.createElement(t.strong,null,"removes"),": ",s.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">{(id, timestamp)}</code>'}})," (sometimes referred to as ",s.createElement(t.strong,null,"tombstones"),")"),"\n"),"\n",s.createElement(t.p,null,"The 2P-Set is a ",s.createElement(t.strong,null,"free product")," of these two set lattices, which is to say that the 2P-Set ",s.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">merge</code>'}})," operator  is simply the independent ",s.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">merge</code>'}})," of 2 ",s.createElement(t.strong,null,"adds")," sets, and 2 ",s.createElement(t.strong,null,"removes")," sets:"),"\n",s.createElement(t.div,{className:"math math-display"},s.createElement(t.span,{className:"katex-display"},s.createElement(t.span,{className:"katex"},s.createElement(t.span,{className:"katex-mathml"},s.createElement(t.math,{xmlns:"http://www.w3.org/1998/Math/MathML",display:"block"},s.createElement(t.semantics,null,s.createElement(t.mrow,null,s.createElement(t.mo,{stretchy:"false"},"("),s.createElement(t.msub,null,s.createElement(t.mi,null,"a"),s.createElement(t.mn,null,"1")),s.createElement(t.mo,{separator:"true"},","),s.createElement(t.msub,null,s.createElement(t.mi,null,"r"),s.createElement(t.mn,null,"1")),s.createElement(t.mo,{stretchy:"false"},")"),s.createElement(t.mo,null,"‚äî"),s.createElement(t.mo,{stretchy:"false"},"("),s.createElement(t.msub,null,s.createElement(t.mi,null,"a"),s.createElement(t.mn,null,"2")),s.createElement(t.mo,{separator:"true"},","),s.createElement(t.msub,null,s.createElement(t.mi,null,"r"),s.createElement(t.mn,null,"2")),s.createElement(t.mo,{stretchy:"false"},")"),s.createElement(t.mo,null,"="),s.createElement(t.mo,{stretchy:"false"},"("),s.createElement(t.msub,null,s.createElement(t.mi,null,"a"),s.createElement(t.mn,null,"1")),s.createElement(t.mo,null,"‚äî"),s.createElement(t.msub,null,s.createElement(t.mi,null,"a"),s.createElement(t.mn,null,"2")),s.createElement(t.mo,{separator:"true"},","),s.createElement(t.msub,null,s.createElement(t.mi,null,"b"),s.createElement(t.mn,null,"1")),s.createElement(t.mo,null,"‚äî"),s.createElement(t.msub,null,s.createElement(t.mi,null,"b"),s.createElement(t.mn,null,"2")),s.createElement(t.mo,{stretchy:"false"},")")),s.createElement(t.annotation,{encoding:"application/x-tex"},"(a_1, r_1) \\sqcup (a_2, r_2) =\n(a_1 \\sqcup a_2, b_1 \\sqcup b_2)")))),s.createElement(t.span,{className:"katex-html","aria-hidden":"true"},s.createElement(t.span,{className:"base"},s.createElement(t.span,{className:"strut",style:{height:"1em",verticalAlign:"-0.25em"}}),s.createElement(t.span,{className:"mopen"},"("),s.createElement(t.span,{className:"mord"},s.createElement(t.span,{className:"mord mathnormal"},"a"),s.createElement(t.span,{className:"msupsub"},s.createElement(t.span,{className:"vlist-t vlist-t2"},s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.3011em"}},s.createElement(t.span,{style:{top:"-2.55em",marginLeft:"0em",marginRight:"0.05em"}},s.createElement(t.span,{className:"pstrut",style:{height:"2.7em"}}),s.createElement(t.span,{className:"sizing reset-size6 size3 mtight"},s.createElement(t.span,{className:"mord mtight"},"1")))),s.createElement(t.span,{className:"vlist-s"},"‚Äã")),s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.15em"}},s.createElement(t.span)))))),s.createElement(t.span,{className:"mpunct"},","),s.createElement(t.span,{className:"mspace",style:{marginRight:"0.1667em"}}),s.createElement(t.span,{className:"mord"},s.createElement(t.span,{className:"mord mathnormal",style:{marginRight:"0.02778em"}},"r"),s.createElement(t.span,{className:"msupsub"},s.createElement(t.span,{className:"vlist-t vlist-t2"},s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.3011em"}},s.createElement(t.span,{style:{top:"-2.55em",marginLeft:"-0.0278em",marginRight:"0.05em"}},s.createElement(t.span,{className:"pstrut",style:{height:"2.7em"}}),s.createElement(t.span,{className:"sizing reset-size6 size3 mtight"},s.createElement(t.span,{className:"mord mtight"},"1")))),s.createElement(t.span,{className:"vlist-s"},"‚Äã")),s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.15em"}},s.createElement(t.span)))))),s.createElement(t.span,{className:"mclose"},")"),s.createElement(t.span,{className:"mspace",style:{marginRight:"0.2222em"}}),s.createElement(t.span,{className:"mbin"},"‚äî"),s.createElement(t.span,{className:"mspace",style:{marginRight:"0.2222em"}})),s.createElement(t.span,{className:"base"},s.createElement(t.span,{className:"strut",style:{height:"1em",verticalAlign:"-0.25em"}}),s.createElement(t.span,{className:"mopen"},"("),s.createElement(t.span,{className:"mord"},s.createElement(t.span,{className:"mord mathnormal"},"a"),s.createElement(t.span,{className:"msupsub"},s.createElement(t.span,{className:"vlist-t vlist-t2"},s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.3011em"}},s.createElement(t.span,{style:{top:"-2.55em",marginLeft:"0em",marginRight:"0.05em"}},s.createElement(t.span,{className:"pstrut",style:{height:"2.7em"}}),s.createElement(t.span,{className:"sizing reset-size6 size3 mtight"},s.createElement(t.span,{className:"mord mtight"},"2")))),s.createElement(t.span,{className:"vlist-s"},"‚Äã")),s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.15em"}},s.createElement(t.span)))))),s.createElement(t.span,{className:"mpunct"},","),s.createElement(t.span,{className:"mspace",style:{marginRight:"0.1667em"}}),s.createElement(t.span,{className:"mord"},s.createElement(t.span,{className:"mord mathnormal",style:{marginRight:"0.02778em"}},"r"),s.createElement(t.span,{className:"msupsub"},s.createElement(t.span,{className:"vlist-t vlist-t2"},s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.3011em"}},s.createElement(t.span,{style:{top:"-2.55em",marginLeft:"-0.0278em",marginRight:"0.05em"}},s.createElement(t.span,{className:"pstrut",style:{height:"2.7em"}}),s.createElement(t.span,{className:"sizing reset-size6 size3 mtight"},s.createElement(t.span,{className:"mord mtight"},"2")))),s.createElement(t.span,{className:"vlist-s"},"‚Äã")),s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.15em"}},s.createElement(t.span)))))),s.createElement(t.span,{className:"mclose"},")"),s.createElement(t.span,{className:"mspace",style:{marginRight:"0.2778em"}}),s.createElement(t.span,{className:"mrel"},"="),s.createElement(t.span,{className:"mspace",style:{marginRight:"0.2778em"}})),s.createElement(t.span,{className:"base"},s.createElement(t.span,{className:"strut",style:{height:"1em",verticalAlign:"-0.25em"}}),s.createElement(t.span,{className:"mopen"},"("),s.createElement(t.span,{className:"mord"},s.createElement(t.span,{className:"mord mathnormal"},"a"),s.createElement(t.span,{className:"msupsub"},s.createElement(t.span,{className:"vlist-t vlist-t2"},s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.3011em"}},s.createElement(t.span,{style:{top:"-2.55em",marginLeft:"0em",marginRight:"0.05em"}},s.createElement(t.span,{className:"pstrut",style:{height:"2.7em"}}),s.createElement(t.span,{className:"sizing reset-size6 size3 mtight"},s.createElement(t.span,{className:"mord mtight"},"1")))),s.createElement(t.span,{className:"vlist-s"},"‚Äã")),s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.15em"}},s.createElement(t.span)))))),s.createElement(t.span,{className:"mspace",style:{marginRight:"0.2222em"}}),s.createElement(t.span,{className:"mbin"},"‚äî"),s.createElement(t.span,{className:"mspace",style:{marginRight:"0.2222em"}})),s.createElement(t.span,{className:"base"},s.createElement(t.span,{className:"strut",style:{height:"0.8889em",verticalAlign:"-0.1944em"}}),s.createElement(t.span,{className:"mord"},s.createElement(t.span,{className:"mord mathnormal"},"a"),s.createElement(t.span,{className:"msupsub"},s.createElement(t.span,{className:"vlist-t vlist-t2"},s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.3011em"}},s.createElement(t.span,{style:{top:"-2.55em",marginLeft:"0em",marginRight:"0.05em"}},s.createElement(t.span,{className:"pstrut",style:{height:"2.7em"}}),s.createElement(t.span,{className:"sizing reset-size6 size3 mtight"},s.createElement(t.span,{className:"mord mtight"},"2")))),s.createElement(t.span,{className:"vlist-s"},"‚Äã")),s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.15em"}},s.createElement(t.span)))))),s.createElement(t.span,{className:"mpunct"},","),s.createElement(t.span,{className:"mspace",style:{marginRight:"0.1667em"}}),s.createElement(t.span,{className:"mord"},s.createElement(t.span,{className:"mord mathnormal"},"b"),s.createElement(t.span,{className:"msupsub"},s.createElement(t.span,{className:"vlist-t vlist-t2"},s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.3011em"}},s.createElement(t.span,{style:{top:"-2.55em",marginLeft:"0em",marginRight:"0.05em"}},s.createElement(t.span,{className:"pstrut",style:{height:"2.7em"}}),s.createElement(t.span,{className:"sizing reset-size6 size3 mtight"},s.createElement(t.span,{className:"mord mtight"},"1")))),s.createElement(t.span,{className:"vlist-s"},"‚Äã")),s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.15em"}},s.createElement(t.span)))))),s.createElement(t.span,{className:"mspace",style:{marginRight:"0.2222em"}}),s.createElement(t.span,{className:"mbin"},"‚äî"),s.createElement(t.span,{className:"mspace",style:{marginRight:"0.2222em"}})),s.createElement(t.span,{className:"base"},s.createElement(t.span,{className:"strut",style:{height:"1em",verticalAlign:"-0.25em"}}),s.createElement(t.span,{className:"mord"},s.createElement(t.span,{className:"mord mathnormal"},"b"),s.createElement(t.span,{className:"msupsub"},s.createElement(t.span,{className:"vlist-t vlist-t2"},s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.3011em"}},s.createElement(t.span,{style:{top:"-2.55em",marginLeft:"0em",marginRight:"0.05em"}},s.createElement(t.span,{className:"pstrut",style:{height:"2.7em"}}),s.createElement(t.span,{className:"sizing reset-size6 size3 mtight"},s.createElement(t.span,{className:"mord mtight"},"2")))),s.createElement(t.span,{className:"vlist-s"},"‚Äã")),s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.15em"}},s.createElement(t.span)))))),s.createElement(t.span,{className:"mclose"},")")))))),"\n",s.createElement(t.p,null,"Updates are simple: add an item by inserting into ",s.createElement(t.strong,null,"adds"),", delete an item by placing its id and time of deletion into ",s.createElement(t.strong,null,"removes"),". All good."),"\n",s.createElement(t.p,null,"Until... you try to expire tombstoned data to save space."),"\n",s.createElement(t.h3,null,"Observed-Remove (OR) Sets"),"\n",s.createElement(t.p,null,"The OR-Set CRDT extends 2P-Sets to allow tombstones to be expired, but ... it's tricky! Let's walk through it."),"\n",s.createElement(t.p,null,"A naive scheme for expiring tombstones might work as follows: look at a local wall-clock, and expire ids from ",s.createElement(t.strong,null,"adds")," and ",s.createElement(t.strong,null,"removes"),' whose tombstone timestamps are "older" than a threshold. Turns out that this would be bad! Making this decision based on local time can cause ',s.createElement(t.strong,null,"non-convergent")," behavior."),"\n",s.createElement(t.p,null,'This is not at all obvious (in fact, ChatGPT happily provided incorrect proofs in both directions!), so I constructed a proof by example.  The basic idea is this: even after all updates have been issued, nodes can pass an item back and forth as a "hot potato" indefinitely, and never converge despite communicating infinitely often!'),"\n",s.createElement("details",null,s.createElement("summary",null,"Click to see a non-convergent OR-Set cycle infinitely."),s.createElement("a",{href:"../img/divergence_fsm_piechart.png"},s.createElement("img",{src:"../img/divergence_fsm_piechart.png",alt:"FSM Divergence Diagram"})),s.createElement("p",null,s.createElement(t.p,null,"This diagram shows an oscillating state change cycle -- a single item in an OR-set that uses naive local expiry and never converges, just keeps rotating from state to state forever. Each 'pie' represents a ",s.createElement("em",null,"global")," state of the item, across each of three nodes, ",s.createElement("code",null,"A"),", ",s.createElement("code",null,"B")," and ",s.createElement("code",null,"C"),". In each state, each of the machines either has the item only in the adds set (",s.createElement("code",null,"+"),"), in the adds and removes sets (",s.createElement("code",null,"‚Äî"),") or in neither (",s.createElement("code",null,"?"),"). Edges are labeled with state transitions: ",s.createElement("code",null,"xp@A")," means that the item expired at node ",s.createElement("code",null,"A"),"; ",s.createElement("code",null,"B <- A")," means that node ",s.createElement("code",null,"B")," received a copy of the item from node ",s.createElement("code",null,"A"),".")),s.createElement("p",null,s.createElement(t.p,null,"Click on the image to zoom if needed."))),"\n",s.createElement(t.h4,null,"üßØ Fix: Explicit Causality"),"\n",s.createElement(t.p,null,"This brings us back to the main point of this post: we need to ",s.createElement(t.em,null,"explicitly")," include information in our OR-set semilattice ... in this case, to support convergent expiry of state. Specifically we can use a nested semilattice to track a ",s.createElement(t.strong,null,"causal context"),"‚Äîe.g. a ",s.createElement(t.strong,null,"version vector"),"‚Äîand use that to determine when it's safe to expire items:"),"\n",s.createElement(t.ul,null,"\n",s.createElement(t.li,null,"‚úÖ Expire a tombstone only after every node is guaranteed to know about it."),"\n"),"\n",s.createElement(t.p,null,"Note that this constraint breaks the cycle in the diagram of non-convergence above! It forbids the edges ",s.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">S2 -> S3</code>'}}),", ",s.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">S5 -> S6</code>'}})," and ",s.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">S8 -> S0</code>'}}),": each of those edges represents a tombstone being expired when at least one node is in a green ",s.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">+</code>'}})," state and doesn't believe the tombstone exists!"),"\n",s.createElement(t.p,null,"We enforce the constraint by making the OR-Set semilattice a ",s.createElement(t.a,{href:"https://en.wikipedia.org/wiki/Lexicographic_order"},"lexical product")," semilattice:"),"\n",s.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">(causalContext, (adds, removes))</code></pre></div>'}}),"\n",s.createElement(t.p,null,"Unlike our previous ",s.createElement(t.em,null,"free product"),", the ",s.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">merge</code>'}})," operator for the lexical product only looks at its second field ",s.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">(adds, removes)</code>'}})," when breaking ties on the first field ",s.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">causalContext</code>'}}),":"),"\n",s.createElement(t.div,{className:"math math-display"},s.createElement(t.span,{className:"katex-display"},s.createElement(t.span,{className:"katex"},s.createElement(t.span,{className:"katex-mathml"},s.createElement(t.math,{xmlns:"http://www.w3.org/1998/Math/MathML",display:"block"},s.createElement(t.semantics,null,s.createElement(t.mrow,null,s.createElement(t.mo,{stretchy:"false"},"("),s.createElement(t.mi,null,"c"),s.createElement(t.msub,null,s.createElement(t.mi,null,"C"),s.createElement(t.mn,null,"1")),s.createElement(t.mo,{separator:"true"},","),s.createElement(t.mo,{stretchy:"false"},"("),s.createElement(t.msub,null,s.createElement(t.mi,null,"a"),s.createElement(t.mn,null,"1")),s.createElement(t.mo,{separator:"true"},","),s.createElement(t.msub,null,s.createElement(t.mi,null,"r"),s.createElement(t.mn,null,"1")),s.createElement(t.mo,{stretchy:"false"},")"),s.createElement(t.mo,{stretchy:"false"},")"),s.createElement(t.mo,null,"‚äî"),s.createElement(t.mo,{stretchy:"false"},"("),s.createElement(t.mi,null,"c"),s.createElement(t.msub,null,s.createElement(t.mi,null,"C"),s.createElement(t.mn,null,"2")),s.createElement(t.mo,{separator:"true"},","),s.createElement(t.mo,{stretchy:"false"},"("),s.createElement(t.msub,null,s.createElement(t.mi,null,"a"),s.createElement(t.mn,null,"2")),s.createElement(t.mo,{separator:"true"},","),s.createElement(t.msub,null,s.createElement(t.mi,null,"r"),s.createElement(t.mn,null,"2")),s.createElement(t.mo,{stretchy:"false"},")"),s.createElement(t.mo,{stretchy:"false"},")"),s.createElement(t.mo,null,"="),s.createElement(t.mrow,null,s.createElement(t.mo,{fence:"true"},"{"),s.createElement(t.mtable,{rowspacing:"0.36em",columnalign:"left left",columnspacing:"1em"},s.createElement(t.mtr,null,s.createElement(t.mtd,null,s.createElement(t.mstyle,{scriptlevel:"0",displaystyle:"false"},s.createElement(t.mrow,null,s.createElement(t.mo,{stretchy:"false"},"("),s.createElement(t.mi,null,"c"),s.createElement(t.msub,null,s.createElement(t.mi,null,"C"),s.createElement(t.mn,null,"1")),s.createElement(t.mo,{separator:"true"},","),s.createElement(t.mo,{stretchy:"false"},"("),s.createElement(t.msub,null,s.createElement(t.mi,null,"a"),s.createElement(t.mn,null,"1")),s.createElement(t.mo,{separator:"true"},","),s.createElement(t.msub,null,s.createElement(t.mi,null,"r"),s.createElement(t.mn,null,"1")),s.createElement(t.mo,{stretchy:"false"},")"),s.createElement(t.mo,{stretchy:"false"},")")))),s.createElement(t.mtd,null,s.createElement(t.mstyle,{scriptlevel:"0",displaystyle:"false"},s.createElement(t.mrow,null,s.createElement(t.mtext,null,"if¬†"),s.createElement(t.mi,null,"c"),s.createElement(t.msub,null,s.createElement(t.mi,null,"C"),s.createElement(t.mn,null,"1")),s.createElement(t.mo,null,">"),s.createElement(t.mi,null,"c"),s.createElement(t.msub,null,s.createElement(t.mi,null,"C"),s.createElement(t.mn,null,"2")))))),s.createElement(t.mtr,null,s.createElement(t.mtd,null,s.createElement(t.mstyle,{scriptlevel:"0",displaystyle:"false"},s.createElement(t.mrow,null,s.createElement(t.mtext,null,"¬†"),s.createElement(t.mo,{stretchy:"false"},"("),s.createElement(t.mi,null,"c"),s.createElement(t.msub,null,s.createElement(t.mi,null,"C"),s.createElement(t.mn,null,"2")),s.createElement(t.mo,{separator:"true"},","),s.createElement(t.mo,{stretchy:"false"},"("),s.createElement(t.msub,null,s.createElement(t.mi,null,"a"),s.createElement(t.mn,null,"2")),s.createElement(t.mo,{separator:"true"},","),s.createElement(t.msub,null,s.createElement(t.mi,null,"r"),s.createElement(t.mn,null,"2")),s.createElement(t.mo,{stretchy:"false"},")"),s.createElement(t.mo,{stretchy:"false"},")")))),s.createElement(t.mtd,null,s.createElement(t.mstyle,{scriptlevel:"0",displaystyle:"false"},s.createElement(t.mrow,null,s.createElement(t.mtext,null,"if¬†"),s.createElement(t.mi,null,"c"),s.createElement(t.msub,null,s.createElement(t.mi,null,"C"),s.createElement(t.mn,null,"2")),s.createElement(t.mo,null,">"),s.createElement(t.mi,null,"C"),s.createElement(t.msub,null,s.createElement(t.mi,null,"C"),s.createElement(t.mn,null,"1")))))),s.createElement(t.mtr,null,s.createElement(t.mtd,null,s.createElement(t.mstyle,{scriptlevel:"0",displaystyle:"false"},s.createElement(t.mrow,null,s.createElement(t.mtext,null,"¬†"),s.createElement(t.mo,{stretchy:"false"},"("),s.createElement(t.mi,null,"c"),s.createElement(t.msub,null,s.createElement(t.mi,null,"C"),s.createElement(t.mn,null,"1")),s.createElement(t.mo,null,"‚äî"),s.createElement(t.mi,null,"c"),s.createElement(t.msub,null,s.createElement(t.mi,null,"C"),s.createElement(t.mn,null,"2")),s.createElement(t.mo,{separator:"true"},","),s.createElement(t.mo,{stretchy:"false"},"("),s.createElement(t.msub,null,s.createElement(t.mi,null,"a"),s.createElement(t.mn,null,"1")),s.createElement(t.mo,null,"‚äî"),s.createElement(t.msub,null,s.createElement(t.mi,null,"a"),s.createElement(t.mn,null,"2")),s.createElement(t.mo,{separator:"true"},","),s.createElement(t.msub,null,s.createElement(t.mi,null,"b"),s.createElement(t.mn,null,"1")),s.createElement(t.mo,null,"‚äî"),s.createElement(t.msub,null,s.createElement(t.mi,null,"b"),s.createElement(t.mn,null,"2")),s.createElement(t.mo,{stretchy:"false"},")"),s.createElement(t.mo,{stretchy:"false"},")")))),s.createElement(t.mtd,null,s.createElement(t.mstyle,{scriptlevel:"0",displaystyle:"false"},s.createElement(t.mrow,null,s.createElement(t.mi,null,"o"),s.createElement(t.mi,null,"t"),s.createElement(t.mi,null,"h"),s.createElement(t.mi,null,"e"),s.createElement(t.mi,null,"r"),s.createElement(t.mi,null,"w"),s.createElement(t.mi,null,"i"),s.createElement(t.mi,null,"s"),s.createElement(t.mi,null,"e")))))))),s.createElement(t.annotation,{encoding:"application/x-tex"},"(cC_1, (a_1, r_1)) \\sqcup (cC_2, (a_2, r_2)) =\n\\begin{cases}\n(cC_1, (a_1, r_1)) & \\text{if } cC_1 > cC_2 \\\\\\\n(cC_2, (a_2, r_2)) & \\text{if } cC_2 > CC_1 \\\\\\\n(cC_1 \\sqcup cC_2, (a_1 \\sqcup a_2, b_1 \\sqcup b_2)) & otherwise\n\\end{cases}")))),s.createElement(t.span,{className:"katex-html","aria-hidden":"true"},s.createElement(t.span,{className:"base"},s.createElement(t.span,{className:"strut",style:{height:"1em",verticalAlign:"-0.25em"}}),s.createElement(t.span,{className:"mopen"},"("),s.createElement(t.span,{className:"mord mathnormal"},"c"),s.createElement(t.span,{className:"mord"},s.createElement(t.span,{className:"mord mathnormal",style:{marginRight:"0.07153em"}},"C"),s.createElement(t.span,{className:"msupsub"},s.createElement(t.span,{className:"vlist-t vlist-t2"},s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.3011em"}},s.createElement(t.span,{style:{top:"-2.55em",marginLeft:"-0.0715em",marginRight:"0.05em"}},s.createElement(t.span,{className:"pstrut",style:{height:"2.7em"}}),s.createElement(t.span,{className:"sizing reset-size6 size3 mtight"},s.createElement(t.span,{className:"mord mtight"},"1")))),s.createElement(t.span,{className:"vlist-s"},"‚Äã")),s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.15em"}},s.createElement(t.span)))))),s.createElement(t.span,{className:"mpunct"},","),s.createElement(t.span,{className:"mspace",style:{marginRight:"0.1667em"}}),s.createElement(t.span,{className:"mopen"},"("),s.createElement(t.span,{className:"mord"},s.createElement(t.span,{className:"mord mathnormal"},"a"),s.createElement(t.span,{className:"msupsub"},s.createElement(t.span,{className:"vlist-t vlist-t2"},s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.3011em"}},s.createElement(t.span,{style:{top:"-2.55em",marginLeft:"0em",marginRight:"0.05em"}},s.createElement(t.span,{className:"pstrut",style:{height:"2.7em"}}),s.createElement(t.span,{className:"sizing reset-size6 size3 mtight"},s.createElement(t.span,{className:"mord mtight"},"1")))),s.createElement(t.span,{className:"vlist-s"},"‚Äã")),s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.15em"}},s.createElement(t.span)))))),s.createElement(t.span,{className:"mpunct"},","),s.createElement(t.span,{className:"mspace",style:{marginRight:"0.1667em"}}),s.createElement(t.span,{className:"mord"},s.createElement(t.span,{className:"mord mathnormal",style:{marginRight:"0.02778em"}},"r"),s.createElement(t.span,{className:"msupsub"},s.createElement(t.span,{className:"vlist-t vlist-t2"},s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.3011em"}},s.createElement(t.span,{style:{top:"-2.55em",marginLeft:"-0.0278em",marginRight:"0.05em"}},s.createElement(t.span,{className:"pstrut",style:{height:"2.7em"}}),s.createElement(t.span,{className:"sizing reset-size6 size3 mtight"},s.createElement(t.span,{className:"mord mtight"},"1")))),s.createElement(t.span,{className:"vlist-s"},"‚Äã")),s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.15em"}},s.createElement(t.span)))))),s.createElement(t.span,{className:"mclose"},"))"),s.createElement(t.span,{className:"mspace",style:{marginRight:"0.2222em"}}),s.createElement(t.span,{className:"mbin"},"‚äî"),s.createElement(t.span,{className:"mspace",style:{marginRight:"0.2222em"}})),s.createElement(t.span,{className:"base"},s.createElement(t.span,{className:"strut",style:{height:"1em",verticalAlign:"-0.25em"}}),s.createElement(t.span,{className:"mopen"},"("),s.createElement(t.span,{className:"mord mathnormal"},"c"),s.createElement(t.span,{className:"mord"},s.createElement(t.span,{className:"mord mathnormal",style:{marginRight:"0.07153em"}},"C"),s.createElement(t.span,{className:"msupsub"},s.createElement(t.span,{className:"vlist-t vlist-t2"},s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.3011em"}},s.createElement(t.span,{style:{top:"-2.55em",marginLeft:"-0.0715em",marginRight:"0.05em"}},s.createElement(t.span,{className:"pstrut",style:{height:"2.7em"}}),s.createElement(t.span,{className:"sizing reset-size6 size3 mtight"},s.createElement(t.span,{className:"mord mtight"},"2")))),s.createElement(t.span,{className:"vlist-s"},"‚Äã")),s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.15em"}},s.createElement(t.span)))))),s.createElement(t.span,{className:"mpunct"},","),s.createElement(t.span,{className:"mspace",style:{marginRight:"0.1667em"}}),s.createElement(t.span,{className:"mopen"},"("),s.createElement(t.span,{className:"mord"},s.createElement(t.span,{className:"mord mathnormal"},"a"),s.createElement(t.span,{className:"msupsub"},s.createElement(t.span,{className:"vlist-t vlist-t2"},s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.3011em"}},s.createElement(t.span,{style:{top:"-2.55em",marginLeft:"0em",marginRight:"0.05em"}},s.createElement(t.span,{className:"pstrut",style:{height:"2.7em"}}),s.createElement(t.span,{className:"sizing reset-size6 size3 mtight"},s.createElement(t.span,{className:"mord mtight"},"2")))),s.createElement(t.span,{className:"vlist-s"},"‚Äã")),s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.15em"}},s.createElement(t.span)))))),s.createElement(t.span,{className:"mpunct"},","),s.createElement(t.span,{className:"mspace",style:{marginRight:"0.1667em"}}),s.createElement(t.span,{className:"mord"},s.createElement(t.span,{className:"mord mathnormal",style:{marginRight:"0.02778em"}},"r"),s.createElement(t.span,{className:"msupsub"},s.createElement(t.span,{className:"vlist-t vlist-t2"},s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.3011em"}},s.createElement(t.span,{style:{top:"-2.55em",marginLeft:"-0.0278em",marginRight:"0.05em"}},s.createElement(t.span,{className:"pstrut",style:{height:"2.7em"}}),s.createElement(t.span,{className:"sizing reset-size6 size3 mtight"},s.createElement(t.span,{className:"mord mtight"},"2")))),s.createElement(t.span,{className:"vlist-s"},"‚Äã")),s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.15em"}},s.createElement(t.span)))))),s.createElement(t.span,{className:"mclose"},"))"),s.createElement(t.span,{className:"mspace",style:{marginRight:"0.2778em"}}),s.createElement(t.span,{className:"mrel"},"="),s.createElement(t.span,{className:"mspace",style:{marginRight:"0.2778em"}})),s.createElement(t.span,{className:"base"},s.createElement(t.span,{className:"strut",style:{height:"4.32em",verticalAlign:"-1.91em"}}),s.createElement(t.span,{className:"minner"},s.createElement(t.span,{className:"mopen"},s.createElement(t.span,{className:"delimsizing mult"},s.createElement(t.span,{className:"vlist-t vlist-t2"},s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"2.35em"}},s.createElement(t.span,{style:{top:"-2.2em"}},s.createElement(t.span,{className:"pstrut",style:{height:"3.15em"}}),s.createElement(t.span,{className:"delimsizinginner delim-size4"},s.createElement(t.span,null,"‚é©"))),s.createElement(t.span,{style:{top:"-2.192em"}},s.createElement(t.span,{className:"pstrut",style:{height:"3.15em"}}),s.createElement(t.span,{style:{height:"0.316em",width:"0.8889em"}},s.createElement(t.svg,{xmlns:"http://www.w3.org/2000/svg",width:"0.8889em",height:"0.316em",style:{width:"0.8889em"},viewBox:"0 0 888.89 316",preserveAspectRatio:"xMinYMin"},s.createElement(t.path,{d:"M384 0 H504 V316 H384z M384 0 H504 V316 H384z"})))),s.createElement(t.span,{style:{top:"-3.15em"}},s.createElement(t.span,{className:"pstrut",style:{height:"3.15em"}}),s.createElement(t.span,{className:"delimsizinginner delim-size4"},s.createElement(t.span,null,"‚é®"))),s.createElement(t.span,{style:{top:"-4.292em"}},s.createElement(t.span,{className:"pstrut",style:{height:"3.15em"}}),s.createElement(t.span,{style:{height:"0.316em",width:"0.8889em"}},s.createElement(t.svg,{xmlns:"http://www.w3.org/2000/svg",width:"0.8889em",height:"0.316em",style:{width:"0.8889em"},viewBox:"0 0 888.89 316",preserveAspectRatio:"xMinYMin"},s.createElement(t.path,{d:"M384 0 H504 V316 H384z M384 0 H504 V316 H384z"})))),s.createElement(t.span,{style:{top:"-4.6em"}},s.createElement(t.span,{className:"pstrut",style:{height:"3.15em"}}),s.createElement(t.span,{className:"delimsizinginner delim-size4"},s.createElement(t.span,null,"‚éß")))),s.createElement(t.span,{className:"vlist-s"},"‚Äã")),s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"1.85em"}},s.createElement(t.span)))))),s.createElement(t.span,{className:"mord"},s.createElement(t.span,{className:"mtable"},s.createElement(t.span,{className:"col-align-l"},s.createElement(t.span,{className:"vlist-t vlist-t2"},s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"2.41em"}},s.createElement(t.span,{style:{top:"-4.41em"}},s.createElement(t.span,{className:"pstrut",style:{height:"3.008em"}}),s.createElement(t.span,{className:"mord"},s.createElement(t.span,{className:"mopen"},"("),s.createElement(t.span,{className:"mord mathnormal"},"c"),s.createElement(t.span,{className:"mord"},s.createElement(t.span,{className:"mord mathnormal",style:{marginRight:"0.07153em"}},"C"),s.createElement(t.span,{className:"msupsub"},s.createElement(t.span,{className:"vlist-t vlist-t2"},s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.3011em"}},s.createElement(t.span,{style:{top:"-2.55em",marginLeft:"-0.0715em",marginRight:"0.05em"}},s.createElement(t.span,{className:"pstrut",style:{height:"2.7em"}}),s.createElement(t.span,{className:"sizing reset-size6 size3 mtight"},s.createElement(t.span,{className:"mord mtight"},"1")))),s.createElement(t.span,{className:"vlist-s"},"‚Äã")),s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.15em"}},s.createElement(t.span)))))),s.createElement(t.span,{className:"mpunct"},","),s.createElement(t.span,{className:"mspace",style:{marginRight:"0.1667em"}}),s.createElement(t.span,{className:"mopen"},"("),s.createElement(t.span,{className:"mord"},s.createElement(t.span,{className:"mord mathnormal"},"a"),s.createElement(t.span,{className:"msupsub"},s.createElement(t.span,{className:"vlist-t vlist-t2"},s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.3011em"}},s.createElement(t.span,{style:{top:"-2.55em",marginLeft:"0em",marginRight:"0.05em"}},s.createElement(t.span,{className:"pstrut",style:{height:"2.7em"}}),s.createElement(t.span,{className:"sizing reset-size6 size3 mtight"},s.createElement(t.span,{className:"mord mtight"},"1")))),s.createElement(t.span,{className:"vlist-s"},"‚Äã")),s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.15em"}},s.createElement(t.span)))))),s.createElement(t.span,{className:"mpunct"},","),s.createElement(t.span,{className:"mspace",style:{marginRight:"0.1667em"}}),s.createElement(t.span,{className:"mord"},s.createElement(t.span,{className:"mord mathnormal",style:{marginRight:"0.02778em"}},"r"),s.createElement(t.span,{className:"msupsub"},s.createElement(t.span,{className:"vlist-t vlist-t2"},s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.3011em"}},s.createElement(t.span,{style:{top:"-2.55em",marginLeft:"-0.0278em",marginRight:"0.05em"}},s.createElement(t.span,{className:"pstrut",style:{height:"2.7em"}}),s.createElement(t.span,{className:"sizing reset-size6 size3 mtight"},s.createElement(t.span,{className:"mord mtight"},"1")))),s.createElement(t.span,{className:"vlist-s"},"‚Äã")),s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.15em"}},s.createElement(t.span)))))),s.createElement(t.span,{className:"mclose"},"))"))),s.createElement(t.span,{style:{top:"-2.97em"}},s.createElement(t.span,{className:"pstrut",style:{height:"3.008em"}}),s.createElement(t.span,{className:"mord"},s.createElement(t.span,{className:"mspace"},"¬†"),s.createElement(t.span,{className:"mopen"},"("),s.createElement(t.span,{className:"mord mathnormal"},"c"),s.createElement(t.span,{className:"mord"},s.createElement(t.span,{className:"mord mathnormal",style:{marginRight:"0.07153em"}},"C"),s.createElement(t.span,{className:"msupsub"},s.createElement(t.span,{className:"vlist-t vlist-t2"},s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.3011em"}},s.createElement(t.span,{style:{top:"-2.55em",marginLeft:"-0.0715em",marginRight:"0.05em"}},s.createElement(t.span,{className:"pstrut",style:{height:"2.7em"}}),s.createElement(t.span,{className:"sizing reset-size6 size3 mtight"},s.createElement(t.span,{className:"mord mtight"},"2")))),s.createElement(t.span,{className:"vlist-s"},"‚Äã")),s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.15em"}},s.createElement(t.span)))))),s.createElement(t.span,{className:"mpunct"},","),s.createElement(t.span,{className:"mspace",style:{marginRight:"0.1667em"}}),s.createElement(t.span,{className:"mopen"},"("),s.createElement(t.span,{className:"mord"},s.createElement(t.span,{className:"mord mathnormal"},"a"),s.createElement(t.span,{className:"msupsub"},s.createElement(t.span,{className:"vlist-t vlist-t2"},s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.3011em"}},s.createElement(t.span,{style:{top:"-2.55em",marginLeft:"0em",marginRight:"0.05em"}},s.createElement(t.span,{className:"pstrut",style:{height:"2.7em"}}),s.createElement(t.span,{className:"sizing reset-size6 size3 mtight"},s.createElement(t.span,{className:"mord mtight"},"2")))),s.createElement(t.span,{className:"vlist-s"},"‚Äã")),s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.15em"}},s.createElement(t.span)))))),s.createElement(t.span,{className:"mpunct"},","),s.createElement(t.span,{className:"mspace",style:{marginRight:"0.1667em"}}),s.createElement(t.span,{className:"mord"},s.createElement(t.span,{className:"mord mathnormal",style:{marginRight:"0.02778em"}},"r"),s.createElement(t.span,{className:"msupsub"},s.createElement(t.span,{className:"vlist-t vlist-t2"},s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.3011em"}},s.createElement(t.span,{style:{top:"-2.55em",marginLeft:"-0.0278em",marginRight:"0.05em"}},s.createElement(t.span,{className:"pstrut",style:{height:"2.7em"}}),s.createElement(t.span,{className:"sizing reset-size6 size3 mtight"},s.createElement(t.span,{className:"mord mtight"},"2")))),s.createElement(t.span,{className:"vlist-s"},"‚Äã")),s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.15em"}},s.createElement(t.span)))))),s.createElement(t.span,{className:"mclose"},"))"))),s.createElement(t.span,{style:{top:"-1.53em"}},s.createElement(t.span,{className:"pstrut",style:{height:"3.008em"}}),s.createElement(t.span,{className:"mord"},s.createElement(t.span,{className:"mspace"},"¬†"),s.createElement(t.span,{className:"mopen"},"("),s.createElement(t.span,{className:"mord mathnormal"},"c"),s.createElement(t.span,{className:"mord"},s.createElement(t.span,{className:"mord mathnormal",style:{marginRight:"0.07153em"}},"C"),s.createElement(t.span,{className:"msupsub"},s.createElement(t.span,{className:"vlist-t vlist-t2"},s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.3011em"}},s.createElement(t.span,{style:{top:"-2.55em",marginLeft:"-0.0715em",marginRight:"0.05em"}},s.createElement(t.span,{className:"pstrut",style:{height:"2.7em"}}),s.createElement(t.span,{className:"sizing reset-size6 size3 mtight"},s.createElement(t.span,{className:"mord mtight"},"1")))),s.createElement(t.span,{className:"vlist-s"},"‚Äã")),s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.15em"}},s.createElement(t.span)))))),s.createElement(t.span,{className:"mspace",style:{marginRight:"0.2222em"}}),s.createElement(t.span,{className:"mbin"},"‚äî"),s.createElement(t.span,{className:"mspace",style:{marginRight:"0.2222em"}}),s.createElement(t.span,{className:"mord mathnormal"},"c"),s.createElement(t.span,{className:"mord"},s.createElement(t.span,{className:"mord mathnormal",style:{marginRight:"0.07153em"}},"C"),s.createElement(t.span,{className:"msupsub"},s.createElement(t.span,{className:"vlist-t vlist-t2"},s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.3011em"}},s.createElement(t.span,{style:{top:"-2.55em",marginLeft:"-0.0715em",marginRight:"0.05em"}},s.createElement(t.span,{className:"pstrut",style:{height:"2.7em"}}),s.createElement(t.span,{className:"sizing reset-size6 size3 mtight"},s.createElement(t.span,{className:"mord mtight"},"2")))),s.createElement(t.span,{className:"vlist-s"},"‚Äã")),s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.15em"}},s.createElement(t.span)))))),s.createElement(t.span,{className:"mpunct"},","),s.createElement(t.span,{className:"mspace",style:{marginRight:"0.1667em"}}),s.createElement(t.span,{className:"mopen"},"("),s.createElement(t.span,{className:"mord"},s.createElement(t.span,{className:"mord mathnormal"},"a"),s.createElement(t.span,{className:"msupsub"},s.createElement(t.span,{className:"vlist-t vlist-t2"},s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.3011em"}},s.createElement(t.span,{style:{top:"-2.55em",marginLeft:"0em",marginRight:"0.05em"}},s.createElement(t.span,{className:"pstrut",style:{height:"2.7em"}}),s.createElement(t.span,{className:"sizing reset-size6 size3 mtight"},s.createElement(t.span,{className:"mord mtight"},"1")))),s.createElement(t.span,{className:"vlist-s"},"‚Äã")),s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.15em"}},s.createElement(t.span)))))),s.createElement(t.span,{className:"mspace",style:{marginRight:"0.2222em"}}),s.createElement(t.span,{className:"mbin"},"‚äî"),s.createElement(t.span,{className:"mspace",style:{marginRight:"0.2222em"}}),s.createElement(t.span,{className:"mord"},s.createElement(t.span,{className:"mord mathnormal"},"a"),s.createElement(t.span,{className:"msupsub"},s.createElement(t.span,{className:"vlist-t vlist-t2"},s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.3011em"}},s.createElement(t.span,{style:{top:"-2.55em",marginLeft:"0em",marginRight:"0.05em"}},s.createElement(t.span,{className:"pstrut",style:{height:"2.7em"}}),s.createElement(t.span,{className:"sizing reset-size6 size3 mtight"},s.createElement(t.span,{className:"mord mtight"},"2")))),s.createElement(t.span,{className:"vlist-s"},"‚Äã")),s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.15em"}},s.createElement(t.span)))))),s.createElement(t.span,{className:"mpunct"},","),s.createElement(t.span,{className:"mspace",style:{marginRight:"0.1667em"}}),s.createElement(t.span,{className:"mord"},s.createElement(t.span,{className:"mord mathnormal"},"b"),s.createElement(t.span,{className:"msupsub"},s.createElement(t.span,{className:"vlist-t vlist-t2"},s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.3011em"}},s.createElement(t.span,{style:{top:"-2.55em",marginLeft:"0em",marginRight:"0.05em"}},s.createElement(t.span,{className:"pstrut",style:{height:"2.7em"}}),s.createElement(t.span,{className:"sizing reset-size6 size3 mtight"},s.createElement(t.span,{className:"mord mtight"},"1")))),s.createElement(t.span,{className:"vlist-s"},"‚Äã")),s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.15em"}},s.createElement(t.span)))))),s.createElement(t.span,{className:"mspace",style:{marginRight:"0.2222em"}}),s.createElement(t.span,{className:"mbin"},"‚äî"),s.createElement(t.span,{className:"mspace",style:{marginRight:"0.2222em"}}),s.createElement(t.span,{className:"mord"},s.createElement(t.span,{className:"mord mathnormal"},"b"),s.createElement(t.span,{className:"msupsub"},s.createElement(t.span,{className:"vlist-t vlist-t2"},s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.3011em"}},s.createElement(t.span,{style:{top:"-2.55em",marginLeft:"0em",marginRight:"0.05em"}},s.createElement(t.span,{className:"pstrut",style:{height:"2.7em"}}),s.createElement(t.span,{className:"sizing reset-size6 size3 mtight"},s.createElement(t.span,{className:"mord mtight"},"2")))),s.createElement(t.span,{className:"vlist-s"},"‚Äã")),s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.15em"}},s.createElement(t.span)))))),s.createElement(t.span,{className:"mclose"},"))")))),s.createElement(t.span,{className:"vlist-s"},"‚Äã")),s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"1.91em"}},s.createElement(t.span))))),s.createElement(t.span,{className:"arraycolsep",style:{width:"1em"}}),s.createElement(t.span,{className:"col-align-l"},s.createElement(t.span,{className:"vlist-t vlist-t2"},s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"2.41em"}},s.createElement(t.span,{style:{top:"-4.41em"}},s.createElement(t.span,{className:"pstrut",style:{height:"3.008em"}}),s.createElement(t.span,{className:"mord"},s.createElement(t.span,{className:"mord text"},s.createElement(t.span,{className:"mord"},"if¬†")),s.createElement(t.span,{className:"mord mathnormal"},"c"),s.createElement(t.span,{className:"mord"},s.createElement(t.span,{className:"mord mathnormal",style:{marginRight:"0.07153em"}},"C"),s.createElement(t.span,{className:"msupsub"},s.createElement(t.span,{className:"vlist-t vlist-t2"},s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.3011em"}},s.createElement(t.span,{style:{top:"-2.55em",marginLeft:"-0.0715em",marginRight:"0.05em"}},s.createElement(t.span,{className:"pstrut",style:{height:"2.7em"}}),s.createElement(t.span,{className:"sizing reset-size6 size3 mtight"},s.createElement(t.span,{className:"mord mtight"},"1")))),s.createElement(t.span,{className:"vlist-s"},"‚Äã")),s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.15em"}},s.createElement(t.span)))))),s.createElement(t.span,{className:"mspace",style:{marginRight:"0.2778em"}}),s.createElement(t.span,{className:"mrel"},">"),s.createElement(t.span,{className:"mspace",style:{marginRight:"0.2778em"}}),s.createElement(t.span,{className:"mord mathnormal"},"c"),s.createElement(t.span,{className:"mord"},s.createElement(t.span,{className:"mord mathnormal",style:{marginRight:"0.07153em"}},"C"),s.createElement(t.span,{className:"msupsub"},s.createElement(t.span,{className:"vlist-t vlist-t2"},s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.3011em"}},s.createElement(t.span,{style:{top:"-2.55em",marginLeft:"-0.0715em",marginRight:"0.05em"}},s.createElement(t.span,{className:"pstrut",style:{height:"2.7em"}}),s.createElement(t.span,{className:"sizing reset-size6 size3 mtight"},s.createElement(t.span,{className:"mord mtight"},"2")))),s.createElement(t.span,{className:"vlist-s"},"‚Äã")),s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.15em"}},s.createElement(t.span)))))))),s.createElement(t.span,{style:{top:"-2.97em"}},s.createElement(t.span,{className:"pstrut",style:{height:"3.008em"}}),s.createElement(t.span,{className:"mord"},s.createElement(t.span,{className:"mord text"},s.createElement(t.span,{className:"mord"},"if¬†")),s.createElement(t.span,{className:"mord mathnormal"},"c"),s.createElement(t.span,{className:"mord"},s.createElement(t.span,{className:"mord mathnormal",style:{marginRight:"0.07153em"}},"C"),s.createElement(t.span,{className:"msupsub"},s.createElement(t.span,{className:"vlist-t vlist-t2"},s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.3011em"}},s.createElement(t.span,{style:{top:"-2.55em",marginLeft:"-0.0715em",marginRight:"0.05em"}},s.createElement(t.span,{className:"pstrut",style:{height:"2.7em"}}),s.createElement(t.span,{className:"sizing reset-size6 size3 mtight"},s.createElement(t.span,{className:"mord mtight"},"2")))),s.createElement(t.span,{className:"vlist-s"},"‚Äã")),s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.15em"}},s.createElement(t.span)))))),s.createElement(t.span,{className:"mspace",style:{marginRight:"0.2778em"}}),s.createElement(t.span,{className:"mrel"},">"),s.createElement(t.span,{className:"mspace",style:{marginRight:"0.2778em"}}),s.createElement(t.span,{className:"mord mathnormal",style:{marginRight:"0.07153em"}},"C"),s.createElement(t.span,{className:"mord"},s.createElement(t.span,{className:"mord mathnormal",style:{marginRight:"0.07153em"}},"C"),s.createElement(t.span,{className:"msupsub"},s.createElement(t.span,{className:"vlist-t vlist-t2"},s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.3011em"}},s.createElement(t.span,{style:{top:"-2.55em",marginLeft:"-0.0715em",marginRight:"0.05em"}},s.createElement(t.span,{className:"pstrut",style:{height:"2.7em"}}),s.createElement(t.span,{className:"sizing reset-size6 size3 mtight"},s.createElement(t.span,{className:"mord mtight"},"1")))),s.createElement(t.span,{className:"vlist-s"},"‚Äã")),s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"0.15em"}},s.createElement(t.span)))))))),s.createElement(t.span,{style:{top:"-1.53em"}},s.createElement(t.span,{className:"pstrut",style:{height:"3.008em"}}),s.createElement(t.span,{className:"mord"},s.createElement(t.span,{className:"mord mathnormal"},"o"),s.createElement(t.span,{className:"mord mathnormal"},"t"),s.createElement(t.span,{className:"mord mathnormal"},"h"),s.createElement(t.span,{className:"mord mathnormal",style:{marginRight:"0.02778em"}},"er"),s.createElement(t.span,{className:"mord mathnormal",style:{marginRight:"0.02691em"}},"w"),s.createElement(t.span,{className:"mord mathnormal"},"i"),s.createElement(t.span,{className:"mord mathnormal"},"se")))),s.createElement(t.span,{className:"vlist-s"},"‚Äã")),s.createElement(t.span,{className:"vlist-r"},s.createElement(t.span,{className:"vlist",style:{height:"1.91em"}},s.createElement(t.span))))))),s.createElement(t.span,{className:"mclose nulldelimiter"}))))))),"\n",s.createElement(t.p,null,"Note that the ",s.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">causalContext</code>'}})," is itself another semilattice! It tracks which operations have been observed system-wide. This tracking can be stale, but it is always a conservative lower bound. We can safely expire data from our OR set if it is older than our ",s.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">causalContext</code>'}}),"."),"\n",s.createElement(t.p,null,"There are different implementations for ",s.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">causalContext</code>'}}),", including ",s.createElement(t.em,null,"version vectors")," or ",s.createElement(t.em,null,"causal graphs"),". We'll work with version vectors since they're the most common."),"\n",s.createElement("details",null,s.createElement("summary",null,"Click to learn about version vectors."),s.createElement(t.p,null,"We begin by ensuring that each node maintains a ",s.createElement(t.em,null,"local clock")," -- a counter that increments by 1 each time the node applies an operation or sends a message. (Note that a counter is also a semilattice, where the domain ",s.createElement(t.span,{className:"math math-inline"},s.createElement(t.span,{className:"katex"},s.createElement(t.span,{className:"katex-mathml"},s.createElement(t.math,{xmlns:"http://www.w3.org/1998/Math/MathML"},s.createElement(t.semantics,null,s.createElement(t.mrow,null,s.createElement(t.mi,null,"S"),s.createElement(t.mo,null,"="),s.createElement(t.mi,{mathvariant:"double-struck"},"N")),s.createElement(t.annotation,{encoding:"application/x-tex"},"S = \\mathbb{N}")))),s.createElement(t.span,{className:"katex-html","aria-hidden":"true"},s.createElement(t.span,{className:"base"},s.createElement(t.span,{className:"strut",style:{height:"0.6833em"}}),s.createElement(t.span,{className:"mord mathnormal",style:{marginRight:"0.05764em"}},"S"),s.createElement(t.span,{className:"mspace",style:{marginRight:"0.2778em"}}),s.createElement(t.span,{className:"mrel"},"="),s.createElement(t.span,{className:"mspace",style:{marginRight:"0.2778em"}})),s.createElement(t.span,{className:"base"},s.createElement(t.span,{className:"strut",style:{height:"0.6889em"}}),s.createElement(t.span,{className:"mord mathbb"},"N")))))," is the natural numbers 0, 1, 2, ..., and the ",s.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">merge</code>'}})," function is ",s.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">max</code>'}}),".)"),s.createElement("br"),s.createElement("br"),s.createElement(t.p,null,"A ",s.createElement(t.em,null,"version vector")," is a map from ",s.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">nodeId</code>'}}),"s to values from a counter lattice: it records the highest clock value a node has heard of ",s.createElement(t.em,null,"from each other node"),". This map is itself a composite semilattice! Specifically:"),s.createElement(t.ul,null,"\n",s.createElement(t.li,null,"The domain ",s.createElement(t.span,{className:"math math-inline"},s.createElement(t.span,{className:"katex"},s.createElement(t.span,{className:"katex-mathml"},s.createElement(t.math,{xmlns:"http://www.w3.org/1998/Math/MathML"},s.createElement(t.semantics,null,s.createElement(t.mrow,null,s.createElement(t.mi,null,"S")),s.createElement(t.annotation,{encoding:"application/x-tex"},"S")))),s.createElement(t.span,{className:"katex-html","aria-hidden":"true"},s.createElement(t.span,{className:"base"},s.createElement(t.span,{className:"strut",style:{height:"0.6833em"}}),s.createElement(t.span,{className:"mord mathnormal",style:{marginRight:"0.05764em"}},"S")))))," is a map from ",s.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">nodeId</code>'}})," (the key) to a value from the lattice ",s.createElement(t.span,{className:"math math-inline"},s.createElement(t.span,{className:"katex"},s.createElement(t.span,{className:"katex-mathml"},s.createElement(t.math,{xmlns:"http://www.w3.org/1998/Math/MathML"},s.createElement(t.semantics,null,s.createElement(t.mrow,null,s.createElement(t.mo,{stretchy:"false"},"("),s.createElement(t.mi,{mathvariant:"double-struck"},"N"),s.createElement(t.mo,{separator:"true"},",")),s.createElement(t.annotation,{encoding:"application/x-tex"},"(\\mathbb{N},")))),s.createElement(t.span,{className:"katex-html","aria-hidden":"true"},s.createElement(t.span,{className:"base"},s.createElement(t.span,{className:"strut",style:{height:"1em",verticalAlign:"-0.25em"}}),s.createElement(t.span,{className:"mopen"},"("),s.createElement(t.span,{className:"mord mathbb"},"N"),s.createElement(t.span,{className:"mpunct"},",")))))," ",s.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">max</code>'}}),s.createElement(t.span,{className:"math math-inline"},s.createElement(t.span,{className:"katex"},s.createElement(t.span,{className:"katex-mathml"},s.createElement(t.math,{xmlns:"http://www.w3.org/1998/Math/MathML"},s.createElement(t.semantics,null,s.createElement(t.mrow,null,s.createElement(t.mo,{stretchy:"false"},")")),s.createElement(t.annotation,{encoding:"application/x-tex"},")")))),s.createElement(t.span,{className:"katex-html","aria-hidden":"true"},s.createElement(t.span,{className:"base"},s.createElement(t.span,{className:"strut",style:{height:"1em",verticalAlign:"-0.25em"}}),s.createElement(t.span,{className:"mclose"},")")))))," (the value)"),"\n",s.createElement(t.li,null,"The ",s.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">merge</code>'}})," function is simply key-wise application of the value lattice ",s.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">merge</code>'}})," function (i.e., ",s.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">max</code>'}}),"). If a key is missing from one input to ",s.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">merge</code>'}}),", we simply take its value from the other input."),"\n")),"\n",s.createElement(t.p,null,"Notice what we did here: we formed a ",s.createElement(t.em,null,"composite")," semilattice ",s.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">(causalContext, (adds, removes))</code>'}})," out of very simple semilattice building blocks.\nThe ",s.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">merge</code>'}})," functions of these lattices effectively invoke the encapsulated sub-lattice ",s.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">merge</code>'}})," functions recursively."),"\n",s.createElement(t.p,null,s.createElement(t.em,null,"It really is lattices all the way down!")),"\n",s.createElement(t.h4,null,"Using Version Vectors for Safe Expiration"),"\n",s.createElement(t.p,null,"To use our version vectors, we will make a few small changes to our OR-set design:"),"\n",s.createElement(t.ol,null,"\n",s.createElement(t.li,null,"Each node locally maintains an overall version vector containing the ",s.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">merge</code>'}})," of ",s.createElement(t.em,null,"all")," version vectors seen so far: this is typically called a ",s.createElement(t.em,null,"vector clock"),". It represents a high-watermark of our local knowledge of global progress."),"\n",s.createElement(t.li,null,"When an item is deleted, its tombstone timestamp is set to the local vector clock."),"\n"),"\n",s.createElement(t.p,null,"We can now do expiration safely: tombstones are only expired if their timestamp is lower in the partial order than the local ",s.createElement(t.em,null,"vector clock"),": if so, we can be sure that ",s.createElement(t.em,null,"every other node also knows about this tombstone, and will eventually expire it as well"),"."),"\n",s.createElement(t.h2,null,s.createElement("a",{id:"op-based"}),"A Note on Op-Based CRDTS"),"\n",s.createElement(t.p,null,'As mentioned above, many CRDT fans like to talk about two "different" kinds of CRDTs: normal ("state-based") semilattice CRDTs, and something called "op-based" CRDTs. ',s.createElement(t.em,null,"I'm here to tell you that correct op-based CRDTs are also semilattices; the distinction is not fundamental.")),"\n",s.createElement(t.p,null,'An "op-based" CRDT is just a particular class of semilattice. The state of an op-based CRDT represents a ',s.createElement(t.em,null,"partially-ordered log of operations")," (opaque commands). The CRDT's job is to ensure that the partially-ordered log is consistent across nodes."),"\n",s.createElement(t.p,null,"The partial order among ops can be captured by each site tagging every new op it generates with a ",s.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">causalContext</code>'}})," value. This ensures (1) that recipients of ops from node ",s.createElement(t.span,{className:"math math-inline"},s.createElement(t.span,{className:"katex"},s.createElement(t.span,{className:"katex-mathml"},s.createElement(t.math,{xmlns:"http://www.w3.org/1998/Math/MathML"},s.createElement(t.semantics,null,s.createElement(t.mrow,null,s.createElement(t.mi,null,"n")),s.createElement(t.annotation,{encoding:"application/x-tex"},"n")))),s.createElement(t.span,{className:"katex-html","aria-hidden":"true"},s.createElement(t.span,{className:"base"},s.createElement(t.span,{className:"strut",style:{height:"0.4306em"}}),s.createElement(t.span,{className:"mord mathnormal"},"n")))))," will have them ordered in the same way as ",s.createElement(t.span,{className:"math math-inline"},s.createElement(t.span,{className:"katex"},s.createElement(t.span,{className:"katex-mathml"},s.createElement(t.math,{xmlns:"http://www.w3.org/1998/Math/MathML"},s.createElement(t.semantics,null,s.createElement(t.mrow,null,s.createElement(t.mi,null,"n")),s.createElement(t.annotation,{encoding:"application/x-tex"},"n")))),s.createElement(t.span,{className:"katex-html","aria-hidden":"true"},s.createElement(t.span,{className:"base"},s.createElement(t.span,{className:"strut",style:{height:"0.4306em"}}),s.createElement(t.span,{className:"mord mathnormal"},"n")))))," did, and (2) operations ",s.createElement(t.em,null,"across")," nodes are causally ordered, via the ",s.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">causalContext</code>'}}),"."),"\n",s.createElement(t.p,null,"Specifically, the state ",s.createElement(t.span,{className:"math math-inline"},s.createElement(t.span,{className:"katex"},s.createElement(t.span,{className:"katex-mathml"},s.createElement(t.math,{xmlns:"http://www.w3.org/1998/Math/MathML"},s.createElement(t.semantics,null,s.createElement(t.mrow,null,s.createElement(t.mi,null,"S")),s.createElement(t.annotation,{encoding:"application/x-tex"},"S")))),s.createElement(t.span,{className:"katex-html","aria-hidden":"true"},s.createElement(t.span,{className:"base"},s.createElement(t.span,{className:"strut",style:{height:"0.6833em"}}),s.createElement(t.span,{className:"mord mathnormal",style:{marginRight:"0.05764em"}},"S")))))," of an op-based CRDT can simply be a ",s.createElement(t.em,null,"set")," of ",s.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">(causalContext, op)</code>'}})," tuples, with simple set-union as the ",s.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">merge</code>'}})," function. The ",s.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">causalContext</code>'}})," is ignored by the lattice ",s.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">merge</code>'}}),", but carried along to preserve a consistent partial order of the log. One typical ",s.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">causalContext</code>'}})," implementation is to use vector clock timestamps, with each node incrementing its entry in the vector clock for every op and message."),"\n",s.createElement(t.p,null,"That's really all there is to an \"op-based\" CRDT: it's a grow-only set of causally-stamped commands."),"\n",s.createElement(t.p,null,'Typically, op-based CRDT designs assume that the log at each site is "played" (eagerly or lazily), by executing the ops in their causal partial order to materialize the local state. This is only required to support a "read" operation, and hence is effectively outside the scope of the CRDT math. Because causal order is only a partial order, different nodes could "play" some ops in different orders. As a result, op-based CRDT designs typically require the ops themselves to be mutually commutative.'),"\n",s.createElement(t.p,null,'If an op-based CRDT has quiesced and propagated to every node, and the ops themselves are mutually commutative, then every node can "play" the log in some total order that respects the partial order, and all nodes will end up with a convergent outcome.'),"\n",s.createElement(t.p,null,"To summarize: an op-based CRDT is still just a simple set semilattice! The only wrinkles are:"),"\n",s.createElement(t.ol,null,"\n",s.createElement(t.li,null,"The items in the op-based CRDT set are stamped with causalContext to enable causally-ordered replay"),"\n",s.createElement(t.li,null,"For the ops to be meaningful at replay time, ops across sites should be commutative."),"\n"),"\n",s.createElement(t.h2,null,"ü™ú ",s.createElement("a",{id:"building-on-an-existing-turtle"}),"You Can Build on a Turtle ‚Äî But Know What It Carries"),"\n",s.createElement(t.p,null,"Sometimes, a system's lower layers provide additional guarantees that allow us to skip some details and rely on a turtle below us."),"\n",s.createElement(t.blockquote,null,"\n",s.createElement(t.p,null,"Example: If your network guarantees causal delivery, you can safely drop explicit causal tracking in your CRDT."),"\n"),"\n",s.createElement(t.p,null,"But beware: your CRDT is now resting on that turtle. If the network is not in fact behaving like a causal semilattice, your convergence proofs go out the window!"),"\n",s.createElement(t.h2,null,"üìå Takeaways"),"\n",s.createElement(t.ul,null,"\n",s.createElement(t.li,null,"‚úÖ Every CRDT must be a (correct) semilattice"),"\n",s.createElement(t.li,null,"‚úÖ Order comparisons must respect the partial order induced by ",s.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">merge</code>'}}),"."),"\n",s.createElement(t.li,null,"‚úÖ Model all necessary assumptions ",s.createElement(t.em,null,"inside")," the lattice."),"\n",s.createElement(t.li,null,"‚úÖ Build on trusted turtles only when you know exactly what they can carry safely."),"\n"),"\n",s.createElement(t.p,null,"When you do all that?"),"\n",s.createElement(t.blockquote,null,"\n",s.createElement(t.p,null,s.createElement(t.strong,null,"It's semilattices all the way down"),"."),"\n"),"\n",s.createElement(t.p,null,"That's math you can build on."))}var m=function(e){void 0===e&&(e={});const{wrapper:t}=Object.assign({},(0,l.RP)(),e.components);return t?s.createElement(t,e,s.createElement(n,e)):n(e)},c=a(4794),r=a(2532),i=a(4967),p=a(3895),o=a(7528),E=a(6163);const h=e=>{var t;let{data:a,location:l,children:n}=e;const m=a.mdx,o=(null===(t=a.site.siteMetadata)||void 0===t?void 0:t.title)||"Title",h=(0,r.c)(m.frontmatter.coverImage),u=m.frontmatter.coverImageCaption;return s.createElement(p.A,{location:l,title:o},s.createElement("article",{className:"blog-post",itemScope:!0,itemType:"http://schema.org/Article"},s.createElement("header",null,s.createElement("h1",{className:"blog-post-title",itemProp:"headline"},m.frontmatter.title),s.createElement("p",null,m.frontmatter.date," ‚Ä¢ ",m.fields.readingTime),h&&s.createElement("div",{style:{width:"30%",float:"right",marginLeft:"2rem",marginBottom:"2rem",background:"#fafaff",border:"1px solid #eee",borderRadius:"8px",boxShadow:"0 2px 8px rgba(0,0,0,0.04)",padding:"1rem"}},s.createElement(r.G,{image:h,alt:m.frontmatter.title,style:{width:"100%",borderRadius:"4px",marginBottom:u?"0.5rem":"0"}}),u&&u.trim()&&s.createElement("figcaption",{className:"cover-image-caption",style:{textAlign:"left",color:"#666",fontSize:"0.85rem",lineHeight:"1.4",margin:"0"},dangerouslySetInnerHTML:{__html:u}}))),s.createElement("section",{className:"content",itemProp:"articleBody"},n),s.createElement("hr"),s.createElement("footer",null,s.createElement(i.A),s.createElement(E.A))),s.createElement("nav",{className:"blog-post-nav"},s.createElement("ul",{style:{display:"flex",flexWrap:"wrap",justifyContent:"space-between",listStyle:"none",padding:0}},s.createElement("li",null,a.previous&&s.createElement(c.Link,{to:a.previous.fields.slug,rel:"prev"},"‚Üê ",a.previous.frontmatter.title)),s.createElement("li",null,a.next&&s.createElement(c.Link,{to:a.next.fields.slug,rel:"next"},a.next.frontmatter.title," ‚Üí")))))},u=e=>{let{data:t}=e;return s.createElement(o.A,{title:t.mdx.frontmatter.title,description:t.mdx.frontmatter.description||t.mdx.excerpt})};function g(e){return s.createElement(h,e,s.createElement(m,e))}}}]);
//# sourceMappingURL=component---src-templates-blog-post-js-content-file-path-content-blog-crdt-turtles-index-mdx-ba20afae854079e0ae37.js.map